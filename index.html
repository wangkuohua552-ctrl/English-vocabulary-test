<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸­è‹±æ–‡ AI ç™¼éŸ³æ•™ç·´</title>
    <style>
        :root { --primary: #4a90e2; --secondary: #ff4757; --success: #2ecc71; --bg: #f8f9fa; --sentence: #9b59b6; --phrase: #e67e22; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; }
        .container { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; }
        .type-badge { display: inline-block; padding: 6px 16px; border-radius: 50px; color: white; font-size: 14px; margin-bottom: 15px; font-weight: bold; }
        .word-title { font-size: 32px; margin: 15px 0; color: #2d3436; line-height: 1.3; min-height: 100px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .chinese { font-size: 1.3rem; color: var(--primary); font-weight: bold; margin-bottom: 20px; }
        .btn { padding: 15px 25px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; margin: 5px; font-size: 16px; }
        .btn-record { background: var(--secondary); color: white; width: 100%; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        .btn-record.active { background: #333; animation: pulse 1s infinite; }
        #feedbackArea { margin-top: 20px; text-align: left; padding: 20px; border-radius: 15px; background: #fff9db; display: none; border-left: 10px solid #f1c40f; }
        .diag-success { color: #27ae60; font-weight: bold; }
        .diag-error { color: #c0392b; font-weight: bold; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="container">
    <div id="typeBadge" class="type-badge">è¼‰å…¥ä¸­...</div>
    <div class="word-card">
        <div class="word-title" id="displayWord">...</div>
        <button class="btn" style="background:#f1f2f6" onclick="playTargetVoice()">ğŸ”Š è½æ­£ç¢ºç™¼éŸ³</button>
        <div class="chinese" id="displayChinese"></div>
        <button id="recordBtn" class="btn btn-record">ğŸ¤ æŒ‰ä½ç·´ç¿’ï¼ˆæ”¾é–‹çµæŸï¼‰</button>
        <div style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn" onclick="prevWord()" style="flex:1; background:#eee;">â—€ ä¸Šä¸€é¡Œ</button>
            <button class="btn" onclick="nextWord()" style="flex:1; background:#eee;">ä¸‹ä¸€é¡Œ â–¶</button>
        </div>
    </div>
    <div id="feedbackArea">
        <div id="aiStatus" style="margin-bottom: 10px;"></div>
        <div id="aiAdvice" style="font-size: 1rem; color: #2c3e50; line-height: 1.5;"></div>
    </div>
</div>

<script>
    let wordBank = [];
    let currentIndex = 0;

    // å®šç¾©ç™¼éŸ³è¦å‰‡åº«
    const pronunciationRules = [
        { id: 'th', pattern: /th/i, advice: "è«‹æ³¨æ„ th çš„éŸ³ï¼Œè¦æŠŠèˆŒå°–è¼•è¼•æ”¾åœ¨ä¸Šä¸‹æ’ç‰™é½’ä¸­é–“å¹æ°£å–”ã€‚" },
        { id: 'r', pattern: /r/i, advice: "é€™å€‹å­—æœ‰æ²èˆŒéŸ³ rï¼Œè¨˜å¾—èˆŒé ­è¦å¾€å¾Œç¸®ï¼Œä¸è¦ç¢°åˆ°ä¸Šé¡ã€‚" },
        { id: 'v', pattern: /v/i, advice: "ç™¼ v çš„éŸ³æ™‚ï¼Œè¨˜å¾—ç”¨ä¸Šæ’ç‰™é½’è¼•è¼•å’¬ä½ä¸‹å”‡ç™¼éŸ³ã€‚" },
        { id: 'l', pattern: /l/i, advice: "æ³¨æ„ l çš„éŸ³ï¼ŒèˆŒå°–è¦æŠµä½ä¸Šæ’ç‰™é½’çš„å¾Œæ–¹ã€‚" },
        { id: 's', pattern: /s$|s /i, advice: "å­—å°¾çš„ s è²éŸ³è¦ç™¼å‡ºä¾†ï¼Œåƒå˜¶å˜¶è²ä¸€æ¨£ã€‚" }
    ];

    async function loadWords() {
        const response = await fetch('words.json?v=' + Date.now());
        wordBank = await response.json();
        wordBank.sort(() => Math.random() - 0.5);
        updateUI();
    }

    function updateUI() {
        if (wordBank.length === 0) return;
        const item = wordBank[currentIndex];
        document.getElementById('displayWord').innerText = item.word;
        document.getElementById('displayChinese').innerText = item.chinese;
        
        const badge = document.getElementById('typeBadge');
        if (item.type === 'sentence') { 
            badge.innerText = "â­ æ ¸å¿ƒå¥å‹"; badge.style.background = "#9b59b6";
            document.getElementById('displayWord').style.fontSize = "26px";
        } else {
            badge.innerText = "ğŸ“– å–®å­—ç·´ç¿’"; badge.style.background = "#4a90e2";
            document.getElementById('displayWord').style.fontSize = "32px";
        }
        document.getElementById('feedbackArea').style.display = 'none';
    }

    function playTargetVoice() {
        const utter = new SpeechSynthesisUtterance(wordBank[currentIndex].word);
        utter.lang = 'en-US';
        utter.rate = 0.8;
        window.speechSynthesis.speak(utter);
    }

    function aiSpeak(text) {
        window.speechSynthesis.cancel(); // å…ˆåœæ­¢ä¹‹å‰çš„èªªè©±
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-TW';
        utter.rate = 1.1;
        window.speechSynthesis.speak(utter);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        recognition.continuous = false;
        recognition.interimResults = false;

        const recordBtn = document.getElementById('recordBtn');

        recordBtn.onmousedown = () => { recognition.start(); recordBtn.classList.add('active'); };
        recordBtn.onmouseup = () => { recognition.stop(); recordBtn.classList.remove('active'); };

        recognition.onresult = (e) => {
            const userSpeech = e.results[0][0].transcript.toLowerCase().trim();
            const targetWord = wordBank[currentIndex].word.toLowerCase().replace(/[.,?!]/g, "");
            
            document.getElementById('feedbackArea').style.display = 'block';
            let statusHtml = "";
            let adviceText = "";

            // 1. åˆ¤æ–·æ˜¯å¦å®Œå…¨åŒ¹é…
            if (userSpeech === targetWord) {
                statusHtml = "<span class='diag-success'>âœ… ç™¼éŸ³å®Œç¾ï¼</span>";
                adviceText = "å¤ªæ£’äº†ï¼ä½ çš„ç™¼éŸ³éå¸¸æ¨™æº–ï¼Œè½èµ·ä¾†è·Ÿæ¯èªäººå£«ä¸€æ¨£ã€‚";
            } 
            // 2. åˆ¤æ–·æ˜¯å¦éƒ¨åˆ†åŒ¹é…ï¼ˆç”¨æ–¼å¥å­ï¼‰
            else if (targetWord.includes(userSpeech) || userSpeech.includes(targetWord)) {
                statusHtml = "<span class='diag-success'>âœ… è¾¨è­˜æˆåŠŸ</span>";
                adviceText = "æˆ‘è½æ‡‚äº†ï¼é›–ç„¶æœ‰ä¸€é»é»å£éŸ³ï¼Œä½†æºé€šæ²’å•é¡Œã€‚";
            }
            // 3. ç™¼éŸ³éŒ¯èª¤ï¼šé€²å…¥æ™ºæ…§è¨ºæ–·
            else {
                statusHtml = "<span class='diag-error'>âŒ ç™¼éŸ³ä¸å¤ æ¸…æ™°</span>";
                let ruleAdvice = "è«‹è©¦è‘—å†è½ä¸€æ¬¡æ¨™æº–ç™¼éŸ³ï¼Œä¸¦æ³¨æ„é‡éŸ³ä½ç½®ã€‚";
                
                // æª¢æŸ¥æ˜¯å¦ç¬¦åˆç‰¹å®šéŒ¯èª¤è¦å‰‡
                for (let rule of pronunciationRules) {
                    if (rule.pattern.test(targetWord)) {
                        ruleAdvice = rule.advice;
                        break;
                    }
                }
                adviceText = `æˆ‘è½åˆ°çš„æ˜¯ "${userSpeech}"ã€‚æé†’ä½ ï¼š${ruleAdvice}`;
            }

            document.getElementById('aiStatus').innerHTML = statusHtml;
            document.getElementById('aiAdvice').innerText = adviceText;
            aiSpeak(adviceText);
        };
    }

    function nextWord() { currentIndex = (currentIndex + 1) % wordBank.length; updateUI(); }
    function prevWord() { currentIndex = (currentIndex - 1 + wordBank.length) % wordBank.length; updateUI(); }

    window.onload = loadWords;
</script>
</body>
</html>
