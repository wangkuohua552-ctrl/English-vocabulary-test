<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ‹ä¸­è‹±æ–‡ AI è½èªªæŒ‘æˆ°ç«™</title>
    <style>
        :root { --primary: #4a90e2; --secondary: #ff4757; --success: #2ecc71; --bg: #f8f9fa; --sentence: #9b59b6; --phrase: #e67e22; }
        body { font-family: 'PingFang TC', sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 20px; margin: 0; min-height: 100vh; }
        .container { background: white; width: 95%; max-width: 500px; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); text-align: center; position: relative; }
        .timer-badge { position: absolute; top: 15px; right: 15px; background: var(--secondary); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; display: none; }
        .score-display { font-size: 1.1rem; color: var(--success); font-weight: bold; margin-bottom: 15px; }
        .type-badge { display: inline-block; padding: 6px 16px; border-radius: 50px; color: white; font-size: 14px; margin-bottom: 15px; font-weight: bold; }
        .word-title { font-size: 28px; margin: 15px 0; color: #2d3436; line-height: 1.3; min-height: 80px; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .chinese { font-size: 1.3rem; color: var(--primary); font-weight: bold; margin-bottom: 20px; }
        .btn { padding: 15px 25px; border-radius: 50px; border: none; cursor: pointer; font-weight: bold; margin: 5px; font-size: 16px; transition: 0.3s; }
        .btn-challenge { background: #f39c12; color: white; width: 100%; margin-bottom: 10px; }
        .btn-record { background: var(--secondary); color: white; width: 100%; box-shadow: 0 4px 15px rgba(255, 71, 87, 0.3); }
        .btn-record.active { background: #333; transform: scale(0.95); animation: pulse 1s infinite; }
        #feedbackArea { margin-top: 20px; text-align: left; padding: 20px; border-radius: 15px; background: #fff9db; display: none; border-left: 10px solid #f1c40f; }
        #pronunciationTip { margin-top: 10px; display: none; border-radius: 10px; overflow: hidden; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body onclick="unlockAudio()">

<div class="container">
    <div id="timer" class="timer-badge">20s</div>
    <div class="score-display">ğŸŒŸ ç©åˆ†ï¼š<span id="score">0</span></div>
    
    <button id="challengeBtn" class="btn btn-challenge" onclick="startChallenge()">ğŸš€ é–‹å§‹ 20 ç§’é™æ™‚æŒ‘æˆ°</button>

    <div class="word-card">
        <div id="typeBadge" class="type-badge">æº–å‚™ä¸­</div>
        <div class="word-title" id="displayWord">é»æ“Šä»»æ„è™•å•Ÿå‹•</div>
        <button class="btn" style="background:#f1f2f6" onclick="playTargetVoice()">ğŸ”Š è½æ­£ç¢ºç™¼éŸ³</button>
        <div class="chinese" id="displayChinese"></div>
        
        <button id="recordBtn" class="btn btn-record">ğŸ¤ é•·æŒ‰éŒ„éŸ³ (éš¨æ™‚å¯é‡éŒ„)</button>
        
        <div id="navButtons" style="margin-top:20px; display:flex; gap:10px;">
            <button class="btn" onclick="prevWord()" style="flex:1; background:#eee;">â—€ ä¸Šä¸€é¡Œ</button>
            <button class="btn" onclick="nextWord()" style="flex:1; background:#eee;">ä¸‹ä¸€é¡Œ â–¶</button>
        </div>
    </div>

    <div id="feedbackArea">
        <div id="aiStatus" style="font-weight:bold; margin-bottom:5px;"></div>
        <div id="aiAdvice" style="font-size: 1rem; color: #2c3e50; line-height: 1.5;"></div>
        <div id="pronunciationTip">
            <p style="font-size: 0.8rem; color: #e67e22;">ğŸ’¡ æŠ€å·§æç¤ºï¼šèˆŒå°–éœ€æ”¾åœ¨ç‰™é½’ä¸­é–“å¹æ°£</p>
        </div>
    </div>
</div>

<script>
    let wordBank = [];
    let currentIndex = 0;
    let score = 0;
    let isChallengeActive = false;
    let timeLeft = 20;
    let timerId = null;
    let audioUnlocked = false;

    // è§£é–èªéŸ³
    function unlockAudio() {
        if (audioUnlocked) return;
        window.speechSynthesis.speak(new SpeechSynthesisUtterance(""));
        audioUnlocked = true;
    }

    async function loadWords() {
        try {
            const response = await fetch('words.json?v=' + Date.now());
            wordBank = await response.json();
            wordBank.sort(() => Math.random() - 0.5);
            updateUI();
        } catch (e) { document.getElementById('displayWord').innerText = "è¼‰å…¥å¤±æ•—"; }
    }

    function updateUI() {
        if (wordBank.length === 0) return;
        const item = wordBank[currentIndex];
        const wordEl = document.getElementById('displayWord');
        const badge = document.getElementById('typeBadge');
        
        wordEl.innerText = item.word;
        document.getElementById('displayChinese').innerText = item.chinese;
        badge.innerText = item.type.toUpperCase();
        badge.style.background = item.type === 'sentence' ? "#9b59b6" : "#4a90e2";
        wordEl.style.fontSize = item.type === 'sentence' ? "24px" : "32px";
        document.getElementById('feedbackArea').style.display = 'none';
        document.getElementById('pronunciationTip').style.display = 'none';
    }

    function startChallenge() {
        isChallengeActive = true;
        score = 0;
        timeLeft = 20;
        document.getElementById('score').innerText = score;
        document.getElementById('challengeBtn').style.display = 'none';
        document.getElementById('navButtons').style.display = 'none';
        document.getElementById('timer').style.display = 'block';
        
        aiSpeak("æŒ‘æˆ°é–‹å§‹ï¼ŒäºŒåç§’å€’æ•¸ï¼");

        timerId = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = timeLeft + "s";
            if (timeLeft <= 0) endChallenge();
        }, 1000);
    }

    function endChallenge() {
        clearInterval(timerId);
        isChallengeActive = false;
        document.getElementById('challengeBtn').style.display = 'block';
        document.getElementById('navButtons').style.display = 'flex';
        document.getElementById('timer').style.display = 'none';
        aiSpeak(`æŒ‘æˆ°çµæŸï¼Œä½ å¾—åˆ°äº† ${score} åˆ†ã€‚`);
    }

    function aiSpeak(text) {
        window.speechSynthesis.cancel(); // æ ¸å¿ƒï¼šæ’­æ–°è²éŸ³å‰å…ˆåˆ‡æ–·èˆŠè²éŸ³
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-TW';
        utter.rate = 1.1;
        window.speechSynthesis.speak(utter);
    }

    function playTargetVoice() {
        window.speechSynthesis.cancel();
        const utter = new SpeechSynthesisUtterance(wordBank[currentIndex].word);
        utter.lang = 'en-US';
        utter.rate = 0.8;
        window.speechSynthesis.speak(utter);
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
        const recognition = new SpeechRecognition();
        recognition.lang = 'en-US';
        const recordBtn = document.getElementById('recordBtn');

        recordBtn.onmousedown = () => {
            window.speechSynthesis.cancel(); // æ ¸å¿ƒï¼šæŒ‰ä¸‹çš„ç¬é–“ç«‹åˆ»éœéŸ³ AI
            recognition.start();
            recordBtn.classList.add('active');
        };

        recordBtn.onmouseup = () => {
            recognition.stop();
            recordBtn.classList.remove('active');
        };

        recognition.onresult = (e) => {
            const userSpeech = e.results[0][0].transcript.toLowerCase().trim();
            const target = wordBank[currentIndex].word.toLowerCase().replace(/[.,?!]/g, "");
            
            document.getElementById('feedbackArea').style.display = 'block';
            let advice = "";

            if (userSpeech === target || target.includes(userSpeech)) {
                score += 10;
                document.getElementById('aiStatus').innerHTML = "<span style='color:green'>âœ… å®Œç¾ç™¼éŸ³</span>";
                advice = "å¤ªæ£’äº†ï¼Œå®Œå…¨æ­£ç¢ºï¼";
                if (isChallengeActive) setTimeout(nextWord, 600);
            } else if (target.includes("th") && (userSpeech.includes("s") || userSpeech.includes("f") || userSpeech.includes("z"))) {
                document.getElementById('aiStatus').innerHTML = "<span style='color:orange'>âš ï¸ æ³¨æ„ th éŸ³</span>";
                advice = "æ¥è¿‘äº†ï¼Œä½† th éŸ³è¦æŠŠèˆŒå°–å¤¾åœ¨ç‰™é½’ä¸­é–“å¹æ°£ã€‚";
                document.getElementById('pronunciationTip').style.display = 'block';
            } else {
                document.getElementById('aiStatus').innerHTML = "<span style='color:red'>âŒ è¾¨è­˜ç‚º: " + userSpeech + "</span>";
                advice = "è«‹å†è©¦ä¸€æ¬¡ï¼Œæˆ–æ˜¯æŒ‰å–‡å­è½æ­£ç¢ºç™¼éŸ³ã€‚";
            }

            document.getElementById('score').innerText = score;
            document.getElementById('aiAdvice').innerText = advice;
            aiSpeak(advice);
        };
    }

    function nextWord() { currentIndex = (currentIndex + 1) % wordBank.length; updateUI(); }
    function prevWord() { currentIndex = (currentIndex - 1 + wordBank.length) % wordBank.length; updateUI(); }

    window.onload = loadWords;
</script>
</body>
</html>
